import spidev
import time
import lgpio

# --- CONFIGURATION ---
DAC_CS_PIN = 23   # The DAC Chip Select pin
VREF = 5.0        # Reference Voltage (Check your yellow jumper!)

try:
    print("--- DAC OUTPUT TEST ---")
    
    # 1. Open the GPIO Chip (New Method)
    chip = lgpio.gpiochip_open(0)
    try:
        lgpio.gpio_claim_output(chip, DAC_CS_PIN)
    except:
        pass # Pin already claimed is fine
    
    # 2. Open SPI Bus
    spi = spidev.SpiDev()
    spi.open(0, 0)
    spi.max_speed_hz = 1000000
    spi.mode = 0b01 

    # 3. Output Function
    def set_voltage(voltage):
        if voltage > VREF: voltage = VREF
        if voltage < 0: voltage = 0
        
        # Calculate 16-bit value
        val = int((voltage / VREF) * 65535)
        msb = (val >> 8) & 0xFF
        lsb = val & 0xFF

        # Send to Channel A (Command 0x30)
        lgpio.gpio_write(chip, DAC_CS_PIN, 0) # CS Low (Wake up)
        spi.xfer([0x30, msb, lsb])
        lgpio.gpio_write(chip, DAC_CS_PIN, 1) # CS High (Execute)
        
        # Send to Channel B (Command 0x34)
        lgpio.gpio_write(chip, DAC_CS_PIN, 0)
        spi.xfer([0x34, msb, lsb])
        lgpio.gpio_write(chip, DAC_CS_PIN, 1)

    # 4. Run Loop
    print(f"Generating 2.5V on DA0 and DA1...")
    set_voltage(2.5)
    print("Check Multimeter now. (Press Ctrl+C to stop)")
    
    while True:
        time.sleep(1)

except KeyboardInterrupt:
    print("\nStopped.")
finally:
    spi.close()
    lgpio.gpiochip_close(chip)
